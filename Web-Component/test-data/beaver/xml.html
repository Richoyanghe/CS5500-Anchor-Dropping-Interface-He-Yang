<!DOCTYPE html>
<html>

<script src="json.js"></script>

<body onload="loadXMLDoc()">
    <script>
        function loadXMLDoc() {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    processMerging(this);
                }
            };
            xmlhttp.open("GET", "beaver.raw.xml", true);
            xmlhttp.send();
        }

        function processMerging(xml) {
            let xmlDoc = xml.responseXML;
            let nodes = getElementByXpath(xmlDoc, "//s")

            let targetNodeList = [];
            var result = nodes.iterateNext();
            while (result) {
                let node = result.childNodes[0];
                let chking = isAnchored(node);
                if (chking.isFound) {
                    let node = result.childNodes[0];
                    targetNodeList.push({ node, chking });
                }

                result = nodes.iterateNext();
            }

            let parser = new DOMParser();
            for (let temp of targetNodeList) {
                let node = temp.node;
                let result = temp.chking.result;
                console.log({ result });

                let tree = parser.parseFromString(`<root>${result}</root>`, "text/xml");
                for (let i = 0; i < tree.firstChild.childNodes.length; i++) {
                    let child = tree.firstChild.childNodes[i].cloneNode(true);
                    node.parentElement.insertBefore(child, node);
                }
                node.parentElement.removeChild(node);
            }

            exportNode(xmlDoc);
        }

        function exportNode(xmlDoc) {
            var anXMLSerializer = new XMLSerializer();
            let xmlString = anXMLSerializer.serializeToString(xmlDoc);
            console.log(xmlString)
        }

        function getElementByXpath(document, path) {
            return document.evaluate(path, document, null, XPathResult.ANY_TYPE, null);
        }

        function isAnchored(node) {
            let match = 0;
            let result = node.nodeValue.trim();
            let sentence = anchorList.shift();

            for (let json of sentence) {
                debugger
                if (json.anchor != 0){
                    let anchorText = `<anchor time="${json.anchor}"/>${json.text}`;
                    result = result.replace(json.text, anchorText);
                    console.log(result);
                }

                // if (text.startsWith(json.text)) {
                //     text = text.substring(json.text.length).trim();
                //     match = (json.anchor != 0)
                //     result += (json.anchor != 0) ? `<anchor time="${json.anchor}"/>` : "";
                //     result += json.text;
                // }
            }

            if (match != 0) console.log(result)
            return { isFound: (match != 0), result };
        }
    </script>
</body>

</html>